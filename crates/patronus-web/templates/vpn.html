{% extends "base.html" %}

{% block title %}VPN - Patronus Firewall{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">VPN Management</h1>
    <p class="page-subtitle">Manage WireGuard, OpenVPN, and IPsec connections</p>
    <div class="page-actions">
        <button class="btn btn-secondary btn-sm" onclick="exportVPNConfig()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Export Config
        </button>
        <button class="btn btn-primary btn-sm" onclick="showAddPeerModal()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add VPN Peer
        </button>
    </div>
</div>

<!-- VPN Status Stats -->
<div class="stat-grid">
    <div class="stat-card success">
        <h3>WireGuard Peers</h3>
        <div class="value">{{ wireguard_peers_count }}</div>
        <div class="label">{{ wireguard_active_count }} active</div>
    </div>

    <div class="stat-card info">
        <h3>OpenVPN Tunnels</h3>
        <div class="value">{{ openvpn_tunnels_count }}</div>
        <div class="label">{{ openvpn_active_count }} connected</div>
    </div>

    <div class="stat-card warning">
        <h3>IPsec Tunnels</h3>
        <div class="value">{{ ipsec_tunnels_count }}</div>
        <div class="label">{{ ipsec_active_count }} established</div>
    </div>

    <div class="stat-card danger">
        <h3>Total Bandwidth</h3>
        <div class="value">{{ total_bandwidth }}</div>
        <div class="label">Across all VPNs</div>
    </div>
</div>

<!-- VPN Configuration Tabs -->
<div class="card">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(event, 'wireguard-tab')">
            WireGuard
        </button>
        <button class="tab-btn" onclick="switchTab(event, 'openvpn-tab')">
            OpenVPN
        </button>
        <button class="tab-btn" onclick="switchTab(event, 'ipsec-tab')">
            IPsec
        </button>
    </div>

    <!-- WireGuard Tab -->
    <div id="wireguard-tab" class="tab-content active">
        <div class="card-header">
            <h2 class="card-title">WireGuard Peers</h2>
            <div class="flex gap-2">
                <input type="search" placeholder="Search peers..." class="search-input"
                       oninput="filterPeers(this.value, 'wireguard')">
                <button class="btn btn-sm btn-secondary" onclick="generateQRCode()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                    </svg>
                    Generate QR
                </button>
            </div>
        </div>

        <div class="table-container">
            <table id="wireguard-peers-table">
                <thead>
                    <tr>
                        <th width="30"></th>
                        <th>Name</th>
                        <th>Public Key</th>
                        <th>Endpoint</th>
                        <th>Allowed IPs</th>
                        <th>Status</th>
                        <th>Latest Handshake</th>
                        <th>Transfer</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for peer in wireguard_peers %}
                    <tr class="peer-row">
                        <td>
                            <button class="btn-icon" onclick="togglePeerDetails(this)">▶</button>
                        </td>
                        <td><strong>{{ peer.name }}</strong></td>
                        <td class="text-sm monospace">{{ peer.public_key[0..16] }}...</td>
                        <td class="text-sm">{{ peer.endpoint.as_ref().unwrap_or(&"N/A".to_string()) }}</td>
                        <td class="text-sm">{{ peer.allowed_ips.join(", ") }}</td>
                        <td>
                            {% if peer.is_active %}
                            <span class="badge success">Connected</span>
                            {% else %}
                            <span class="badge danger">Disconnected</span>
                            {% endif %}
                        </td>
                        <td class="text-sm">{{ peer.latest_handshake.as_ref().unwrap_or(&"Never".to_string()) }}</td>
                        <td class="text-sm">
                            <div>↓ {{ peer.rx_bytes }}</div>
                            <div>↑ {{ peer.tx_bytes }}</div>
                        </td>
                        <td>
                            <button class="btn-icon" title="More actions">•••</button>
                        </td>
                    </tr>
                    <tr class="peer-details hidden">
                        <td colspan="9" style="background: var(--bg); padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div>
                                    <div class="text-sm text-muted">Full Public Key</div>
                                    <div class="font-bold monospace text-sm">{{ peer.public_key }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Preshared Key</div>
                                    <div class="font-bold">{{ peer.preshared_key.as_ref().map(|_| "Set").unwrap_or("Not set") }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Persistent Keepalive</div>
                                    <div class="font-bold">{{ peer.persistent_keepalive.map(|k| format!("{}s", k)).unwrap_or("Disabled".to_string()) }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Listen Port</div>
                                    <div class="font-bold">{{ peer.listen_port.unwrap_or(51820) }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Total RX</div>
                                    <div class="font-bold">{{ peer.rx_bytes }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Total TX</div>
                                    <div class="font-bold">{{ peer.tx_bytes }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Created</div>
                                    <div class="font-bold">{{ peer.created_at }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Description</div>
                                    <div class="font-bold">{{ peer.description.as_ref().unwrap_or(&"No description".to_string()) }}</div>
                                </div>
                            </div>

                            <div class="flex gap-2 mt-4">
                                <button class="btn btn-primary btn-sm" onclick="editPeer('{{ peer.name }}', 'wireguard')">
                                    Edit Peer
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="showPeerConfig('{{ peer.name }}', 'wireguard')">
                                    Show Config
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="generateQRForPeer('{{ peer.name }}')">
                                    Show QR Code
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deletePeer('{{ peer.name }}', 'wireguard')">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card-advanced hidden">
            <h3 class="mb-2 font-bold">WireGuard Interface Settings</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                <div>
                    <label class="block text-sm font-bold mb-1">Interface Name</label>
                    <input type="text" value="wg0" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Listen Port</label>
                    <input type="number" value="51820" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Private Key</label>
                    <input type="password" value="********************" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Address</label>
                    <input type="text" value="10.0.0.1/24" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">DNS Servers</label>
                    <input type="text" value="1.1.1.1, 8.8.8.8" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">MTU</label>
                    <input type="number" value="1420" class="w-full">
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary btn-sm">Save Interface Settings</button>
                <button class="btn btn-secondary btn-sm">Reset to Defaults</button>
                <button class="btn btn-secondary btn-sm">Regenerate Keys</button>
            </div>
        </div>
        <button class="btn btn-link mt-4" onclick="toggleAdvanced(this)">Interface Settings ▼</button>
    </div>

    <!-- OpenVPN Tab -->
    <div id="openvpn-tab" class="tab-content">
        <div class="card-header">
            <h2 class="card-title">OpenVPN Tunnels</h2>
            <div class="flex gap-2">
                <input type="search" placeholder="Search tunnels..." class="search-input"
                       oninput="filterPeers(this.value, 'openvpn')">
                <button class="btn btn-sm btn-secondary" onclick="importOVPNConfig()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Import .ovpn
                </button>
            </div>
        </div>

        <div class="table-container">
            <table id="openvpn-tunnels-table">
                <thead>
                    <tr>
                        <th width="30"></th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Protocol</th>
                        <th>Remote Host</th>
                        <th>Port</th>
                        <th>Status</th>
                        <th>Uptime</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tunnel in openvpn_tunnels %}
                    <tr class="peer-row">
                        <td>
                            <button class="btn-icon" onclick="togglePeerDetails(this)">▶</button>
                        </td>
                        <td><strong>{{ tunnel.name }}</strong></td>
                        <td>
                            {% if tunnel.is_server %}
                            <span class="badge info">Server</span>
                            {% else %}
                            <span class="badge warning">Client</span>
                            {% endif %}
                        </td>
                        <td class="text-sm">{{ tunnel.protocol }}</td>
                        <td class="text-sm">{{ tunnel.remote_host.as_ref().unwrap_or(&"N/A".to_string()) }}</td>
                        <td class="text-sm">{{ tunnel.port }}</td>
                        <td>
                            {% if tunnel.is_connected %}
                            <span class="badge success">Connected</span>
                            {% else %}
                            <span class="badge danger">Disconnected</span>
                            {% endif %}
                        </td>
                        <td class="text-sm">{{ tunnel.uptime.as_ref().unwrap_or(&"N/A".to_string()) }}</td>
                        <td>
                            <button class="btn-icon" title="More actions">•••</button>
                        </td>
                    </tr>
                    <tr class="peer-details hidden">
                        <td colspan="9" style="background: var(--bg); padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div>
                                    <div class="text-sm text-muted">Cipher</div>
                                    <div class="font-bold">{{ tunnel.cipher }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Auth Algorithm</div>
                                    <div class="font-bold">{{ tunnel.auth }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Compression</div>
                                    <div class="font-bold">{{ tunnel.compression.as_ref().unwrap_or(&"Disabled".to_string()) }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">TLS Version</div>
                                    <div class="font-bold">{{ tunnel.tls_version }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Virtual IP</div>
                                    <div class="font-bold">{{ tunnel.virtual_ip.as_ref().unwrap_or(&"N/A".to_string()) }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Bytes In</div>
                                    <div class="font-bold">{{ tunnel.bytes_in }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Bytes Out</div>
                                    <div class="font-bold">{{ tunnel.bytes_out }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Certificate Expiry</div>
                                    <div class="font-bold">{{ tunnel.cert_expiry.as_ref().unwrap_or(&"N/A".to_string()) }}</div>
                                </div>
                            </div>

                            <div class="flex gap-2 mt-4">
                                <button class="btn btn-primary btn-sm" onclick="editPeer('{{ tunnel.name }}', 'openvpn')">
                                    Edit Tunnel
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="showPeerConfig('{{ tunnel.name }}', 'openvpn')">
                                    Export .ovpn
                                </button>
                                {% if tunnel.is_connected %}
                                <button class="btn btn-warning btn-sm" onclick="disconnectTunnel('{{ tunnel.name }}', 'openvpn')">
                                    Disconnect
                                </button>
                                {% else %}
                                <button class="btn btn-success btn-sm" onclick="connectTunnel('{{ tunnel.name }}', 'openvpn')">
                                    Connect
                                </button>
                                {% endif %}
                                <button class="btn btn-danger btn-sm" onclick="deletePeer('{{ tunnel.name }}', 'openvpn')">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card-advanced hidden">
            <h3 class="mb-2 font-bold">OpenVPN Server Settings</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                <div>
                    <label class="block text-sm font-bold mb-1">Server Mode</label>
                    <select class="w-full">
                        <option>Remote Access (SSL/TLS)</option>
                        <option>Remote Access (User Auth)</option>
                        <option>Site-to-Site (Shared Key)</option>
                        <option>Site-to-Site (SSL/TLS)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Protocol</label>
                    <select class="w-full">
                        <option>UDP</option>
                        <option>TCP</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Port</label>
                    <input type="number" value="1194" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Tunnel Network</label>
                    <input type="text" value="10.8.0.0/24" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Cipher</label>
                    <select class="w-full">
                        <option>AES-256-GCM</option>
                        <option>AES-128-GCM</option>
                        <option>CHACHA20-POLY1305</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Auth Digest</label>
                    <select class="w-full">
                        <option>SHA256</option>
                        <option>SHA384</option>
                        <option>SHA512</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary btn-sm">Save Server Settings</button>
                <button class="btn btn-secondary btn-sm">Generate Certificates</button>
            </div>
        </div>
        <button class="btn btn-link mt-4" onclick="toggleAdvanced(this)">Server Settings ▼</button>
    </div>

    <!-- IPsec Tab -->
    <div id="ipsec-tab" class="tab-content">
        <div class="card-header">
            <h2 class="card-title">IPsec Tunnels</h2>
            <div class="flex gap-2">
                <input type="search" placeholder="Search tunnels..." class="search-input"
                       oninput="filterPeers(this.value, 'ipsec')">
            </div>
        </div>

        <div class="table-container">
            <table id="ipsec-tunnels-table">
                <thead>
                    <tr>
                        <th width="30"></th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Remote Gateway</th>
                        <th>Local Subnet</th>
                        <th>Remote Subnet</th>
                        <th>Status</th>
                        <th>Phase</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tunnel in ipsec_tunnels %}
                    <tr class="peer-row">
                        <td>
                            <button class="btn-icon" onclick="togglePeerDetails(this)">▶</button>
                        </td>
                        <td><strong>{{ tunnel.name }}</strong></td>
                        <td>
                            <span class="badge info">{{ tunnel.tunnel_type }}</span>
                        </td>
                        <td class="text-sm">{{ tunnel.remote_gateway }}</td>
                        <td class="text-sm">{{ tunnel.local_subnet }}</td>
                        <td class="text-sm">{{ tunnel.remote_subnet }}</td>
                        <td>
                            {% if tunnel.is_established %}
                            <span class="badge success">Established</span>
                            {% else %}
                            <span class="badge danger">Down</span>
                            {% endif %}
                        </td>
                        <td class="text-sm">{{ tunnel.phase }}</td>
                        <td>
                            <button class="btn-icon" title="More actions">•••</button>
                        </td>
                    </tr>
                    <tr class="peer-details hidden">
                        <td colspan="9" style="background: var(--bg); padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div>
                                    <div class="text-sm text-muted">IKE Version</div>
                                    <div class="font-bold">{{ tunnel.ike_version }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Encryption</div>
                                    <div class="font-bold">{{ tunnel.encryption }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Hash Algorithm</div>
                                    <div class="font-bold">{{ tunnel.hash_algorithm }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">DH Group</div>
                                    <div class="font-bold">{{ tunnel.dh_group }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Lifetime</div>
                                    <div class="font-bold">{{ tunnel.lifetime }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">NAT-T</div>
                                    <div class="font-bold">{{ tunnel.nat_traversal.map(|n| if n { "Enabled" } else { "Disabled" }).unwrap_or("N/A") }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">DPD Interval</div>
                                    <div class="font-bold">{{ tunnel.dpd_interval.map(|d| format!("{}s", d)).unwrap_or("Disabled".to_string()) }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Bytes In/Out</div>
                                    <div class="font-bold">{{ tunnel.bytes_in }} / {{ tunnel.bytes_out }}</div>
                                </div>
                            </div>

                            <div class="flex gap-2 mt-4">
                                <button class="btn btn-primary btn-sm" onclick="editPeer('{{ tunnel.name }}', 'ipsec')">
                                    Edit Tunnel
                                </button>
                                {% if tunnel.is_established %}
                                <button class="btn btn-warning btn-sm" onclick="disconnectTunnel('{{ tunnel.name }}', 'ipsec')">
                                    Disconnect
                                </button>
                                {% else %}
                                <button class="btn btn-success btn-sm" onclick="connectTunnel('{{ tunnel.name }}', 'ipsec')">
                                    Connect
                                </button>
                                {% endif %}
                                <button class="btn btn-secondary btn-sm" onclick="showPeerConfig('{{ tunnel.name }}', 'ipsec')">
                                    Show Config
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deletePeer('{{ tunnel.name }}', 'ipsec')">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card-advanced hidden">
            <h3 class="mb-2 font-bold">IPsec Global Settings</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                <div>
                    <label class="block text-sm font-bold mb-1">Default IKE Version</label>
                    <select class="w-full">
                        <option>IKEv2</option>
                        <option>IKEv1</option>
                        <option>Auto</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Preferred Encryption</label>
                    <select class="w-full">
                        <option>AES-256-GCM</option>
                        <option>AES-128-GCM</option>
                        <option>3DES</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Default DH Group</label>
                    <select class="w-full">
                        <option>14 (2048-bit MODP)</option>
                        <option>19 (256-bit ECP)</option>
                        <option>20 (384-bit ECP)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">SA Lifetime</label>
                    <input type="number" value="28800" class="w-full" placeholder="seconds">
                </div>
                <div>
                    <label>
                        <input type="checkbox" checked> Enable NAT Traversal
                    </label>
                </div>
                <div>
                    <label>
                        <input type="checkbox" checked> Enable Dead Peer Detection
                    </label>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary btn-sm">Save Global Settings</button>
                <button class="btn btn-secondary btn-sm">Restart IPsec Service</button>
            </div>
        </div>
        <button class="btn btn-link mt-4" onclick="toggleAdvanced(this)">Global Settings ▼</button>
    </div>
</div>

<!-- Add VPN Peer Modal -->
<div id="addPeerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add VPN Peer</h2>
            <button class="btn-close" onclick="closeAddPeerModal()">&times;</button>
        </div>

        <form id="addPeerForm">
            <div class="tabs" style="margin-bottom: 1.5rem;">
                <button type="button" class="tab-btn active" onclick="switchModalTab(event, 'wireguard-form')">
                    WireGuard
                </button>
                <button type="button" class="tab-btn" onclick="switchModalTab(event, 'openvpn-form')">
                    OpenVPN
                </button>
                <button type="button" class="tab-btn" onclick="switchModalTab(event, 'ipsec-form')">
                    IPsec
                </button>
            </div>

            <!-- WireGuard Form -->
            <div id="wireguard-form" class="tab-content active">
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label class="block text-sm font-bold mb-1">Peer Name *</label>
                        <input type="text" name="wg_name" required placeholder="e.g., laptop-john">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Public Key *</label>
                        <input type="text" name="wg_public_key" required placeholder="Base64-encoded public key">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Allowed IPs *</label>
                        <input type="text" name="wg_allowed_ips" required placeholder="e.g., 10.0.0.2/32">
                    </div>

                    <div class="card-advanced hidden">
                        <h3 class="mb-2 font-bold">Advanced WireGuard Options</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label class="block text-sm font-bold mb-1">Endpoint</label>
                                <input type="text" name="wg_endpoint" placeholder="e.g., example.com:51820">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Preshared Key</label>
                                <input type="text" name="wg_preshared_key" placeholder="Base64-encoded PSK (optional)">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Persistent Keepalive</label>
                                <input type="number" name="wg_keepalive" placeholder="seconds (0 = disabled)">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Description</label>
                                <textarea name="wg_description" rows="3" placeholder="Optional description"></textarea>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link" onclick="toggleAdvanced(this)">Advanced Options ▼</button>
                </div>
            </div>

            <!-- OpenVPN Form -->
            <div id="openvpn-form" class="tab-content">
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label class="block text-sm font-bold mb-1">Tunnel Name *</label>
                        <input type="text" name="ovpn_name" placeholder="e.g., office-vpn">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Type *</label>
                        <select name="ovpn_type">
                            <option value="client">Client</option>
                            <option value="server">Server</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Remote Host</label>
                        <input type="text" name="ovpn_remote" placeholder="e.g., vpn.example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Port *</label>
                        <input type="number" name="ovpn_port" value="1194" required>
                    </div>

                    <div class="card-advanced hidden">
                        <h3 class="mb-2 font-bold">Advanced OpenVPN Options</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label class="block text-sm font-bold mb-1">Protocol</label>
                                <select name="ovpn_protocol">
                                    <option>UDP</option>
                                    <option>TCP</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Cipher</label>
                                <select name="ovpn_cipher">
                                    <option>AES-256-GCM</option>
                                    <option>AES-128-GCM</option>
                                    <option>CHACHA20-POLY1305</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Auth Digest</label>
                                <select name="ovpn_auth">
                                    <option>SHA256</option>
                                    <option>SHA384</option>
                                    <option>SHA512</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">CA Certificate</label>
                                <textarea name="ovpn_ca" rows="4" placeholder="Paste CA certificate"></textarea>
                            </div>
                            <div>
                                <label>
                                    <input type="checkbox" name="ovpn_compression"> Enable compression (LZ4)
                                </label>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link" onclick="toggleAdvanced(this)">Advanced Options ▼</button>
                </div>
            </div>

            <!-- IPsec Form -->
            <div id="ipsec-form" class="tab-content">
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label class="block text-sm font-bold mb-1">Tunnel Name *</label>
                        <input type="text" name="ipsec_name" placeholder="e.g., branch-office">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Remote Gateway *</label>
                        <input type="text" name="ipsec_gateway" required placeholder="e.g., 203.0.113.10">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Local Subnet *</label>
                        <input type="text" name="ipsec_local_subnet" required placeholder="e.g., 192.168.1.0/24">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Remote Subnet *</label>
                        <input type="text" name="ipsec_remote_subnet" required placeholder="e.g., 10.10.0.0/24">
                    </div>

                    <div class="card-advanced hidden">
                        <h3 class="mb-2 font-bold">Advanced IPsec Options</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label class="block text-sm font-bold mb-1">IKE Version</label>
                                <select name="ipsec_ike_version">
                                    <option>IKEv2</option>
                                    <option>IKEv1</option>
                                    <option>Auto</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Encryption</label>
                                <select name="ipsec_encryption">
                                    <option>AES-256-GCM</option>
                                    <option>AES-128-GCM</option>
                                    <option>3DES</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Hash Algorithm</label>
                                <select name="ipsec_hash">
                                    <option>SHA256</option>
                                    <option>SHA384</option>
                                    <option>SHA512</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">DH Group</label>
                                <select name="ipsec_dh_group">
                                    <option>14 (2048-bit MODP)</option>
                                    <option>19 (256-bit ECP)</option>
                                    <option>20 (384-bit ECP)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Pre-Shared Key</label>
                                <input type="password" name="ipsec_psk" placeholder="Shared secret">
                            </div>
                            <div>
                                <label>
                                    <input type="checkbox" name="ipsec_nat_t" checked> Enable NAT Traversal
                                </label>
                            </div>
                            <div>
                                <label>
                                    <input type="checkbox" name="ipsec_dpd" checked> Enable Dead Peer Detection
                                </label>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link" onclick="toggleAdvanced(this)">Advanced Options ▼</button>
                </div>
            </div>

            <div class="flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary">Add Peer</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddPeerModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- QR Code Modal -->
<div id="qrCodeModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>WireGuard QR Code</h2>
            <button class="btn-close" onclick="closeQRCodeModal()">&times;</button>
        </div>

        <div style="text-align: center; padding: 2rem;">
            <div id="qrCodeCanvas" style="background: white; padding: 2rem; border-radius: 0.5rem; display: inline-block;">
                <!-- QR code will be generated here -->
                <div style="width: 256px; height: 256px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                    <span style="color: #999;">QR Code Placeholder</span>
                </div>
            </div>
            <p class="mt-4 text-sm text-muted">Scan this QR code with the WireGuard mobile app</p>
            <div class="flex gap-2 mt-4 justify-center">
                <button class="btn btn-secondary btn-sm" onclick="downloadQRCode()">Download PNG</button>
                <button class="btn btn-secondary btn-sm" onclick="printQRCode()">Print</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Tab switching for main content
function switchTab(event, tabId) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });

    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}

// Tab switching for modal forms
function switchModalTab(event, tabId) {
    const modal = event.target.closest('.modal');

    // Hide all form tabs
    modal.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });

    // Remove active from all modal tab buttons
    modal.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected form
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}

// Toggle peer details
function togglePeerDetails(btn) {
    const row = btn.closest('tr');
    const detailsRow = row.nextElementSibling;
    if (detailsRow && detailsRow.classList.contains('peer-details')) {
        detailsRow.classList.toggle('show');
        btn.textContent = detailsRow.classList.contains('show') ? '▼' : '▶';
    }
}

// Modal functions
function showAddPeerModal() {
    document.getElementById('addPeerModal').classList.add('show');
}

function closeAddPeerModal() {
    document.getElementById('addPeerModal').classList.remove('show');
}

function showQRCodeModal() {
    document.getElementById('qrCodeModal').classList.add('show');
}

function closeQRCodeModal() {
    document.getElementById('qrCodeModal').classList.remove('show');
}

// Close modal on background click
window.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
    }
});

// Filter peers/tunnels
function filterPeers(query, type) {
    const tableId = type + '-peers-table';
    const table = document.getElementById(tableId) || document.getElementById(type + '-tunnels-table');
    if (!table) return;

    const rows = table.querySelectorAll('tbody tr.peer-row');
    query = query.toLowerCase();

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const detailsRow = row.nextElementSibling;

        if (text.includes(query)) {
            row.style.display = '';
            if (detailsRow && detailsRow.classList.contains('peer-details')) {
                detailsRow.style.display = '';
            }
        } else {
            row.style.display = 'none';
            if (detailsRow && detailsRow.classList.contains('peer-details')) {
                detailsRow.style.display = 'none';
            }
        }
    });
}

// Peer actions
function editPeer(name, type) {
    alert(`Edit ${type} peer: ${name}`);
    // TODO: Implement edit functionality
}

function deletePeer(name, type) {
    if (confirm(`Delete ${type} peer "${name}"?`)) {
        alert(`Deleting ${name}...`);
        // TODO: Implement delete via API
    }
}

function showPeerConfig(name, type) {
    alert(`Show config for ${type} peer: ${name}`);
    // TODO: Show config in modal
}

function connectTunnel(name, type) {
    alert(`Connecting ${type} tunnel: ${name}`);
    // TODO: Implement connect via API
}

function disconnectTunnel(name, type) {
    if (confirm(`Disconnect ${type} tunnel "${name}"?`)) {
        alert(`Disconnecting ${name}...`);
        // TODO: Implement disconnect via API
    }
}

// QR Code functions
function generateQRCode() {
    showQRCodeModal();
    // TODO: Generate actual QR code using library
}

function generateQRForPeer(name) {
    showQRCodeModal();
    // TODO: Generate QR for specific peer
}

function downloadQRCode() {
    alert('Downloading QR code as PNG...');
    // TODO: Implement download
}

function printQRCode() {
    window.print();
}

// Export/import functions
function exportVPNConfig() {
    alert('Exporting VPN configuration...');
    // TODO: Implement export
}

function importOVPNConfig() {
    alert('Import .ovpn file...');
    // TODO: Implement file upload
}

// Form submission
document.getElementById('addPeerForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    console.log('Adding peer:', data);

    // TODO: Submit to API
    // const response = await fetch('/api/vpn/peers', {
    //     method: 'POST',
    //     headers: { 'Content-Type': 'application/json' },
    //     body: JSON.stringify(data)
    // });

    alert('Peer added successfully!');
    closeAddPeerModal();
    location.reload();
});
</script>
{% endblock %}
