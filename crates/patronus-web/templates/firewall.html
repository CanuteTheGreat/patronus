{% extends "base.html" %}

{% block title %}Firewall Rules - Patronus{% endblock %}

{% block extra_head %}
<style>
    .rule-table {
        margin-top: 1rem;
    }

    .rule-row {
        cursor: pointer;
        transition: background 0.2s;
    }

    .rule-row:hover {
        background: #f5f5f5;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .tabs {
        display: flex;
        gap: 1rem;
        border-bottom: 2px solid #e5e5e5;
        margin-bottom: 1.5rem;
    }

    .tab {
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
        font-weight: 500;
    }

    .tab.active {
        border-bottom-color: #667eea;
        color: #667eea;
    }

    .tab:hover {
        background: #f5f5f5;
    }

    .add-rule-btn {
        float: right;
        margin-bottom: 1rem;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Firewall Rules Management</h2>

    <button class="btn btn-primary add-rule-btn" onclick="showAddRuleModal()">+ Add Rule</button>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('filter')">Filter Rules</div>
        <div class="tab" onclick="switchTab('nat')">NAT Rules</div>
    </div>

    <!-- Filter Rules -->
    <div id="filter-rules" class="rule-table">
        <table>
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Name</th>
                    <th>Chain</th>
                    <th>Action</th>
                    <th>Source</th>
                    <th>Destination</th>
                    <th>Protocol</th>
                    <th>Port</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for rule in filter_rules %}
                <tr class="rule-row">
                    <td>
                        {% if rule.enabled %}
                        <span class="badge success">Enabled</span>
                        {% else %}
                        <span class="badge danger">Disabled</span>
                        {% endif %}
                    </td>
                    <td><strong>{{ rule.name }}</strong></td>
                    <td>{{ rule.chain }}</td>
                    <td>
                        {% if rule.action == "Accept" %}
                        <span class="badge success">{{ rule.action }}</span>
                        {% elsif rule.action == "Drop" %}
                        <span class="badge danger">{{ rule.action }}</span>
                        {% else %}
                        <span class="badge warning">{{ rule.action }}</span>
                        {% endif %}
                    </td>
                    <td>{{ rule.source.as_ref().unwrap_or(&"ANY".to_string()) }}</td>
                    <td>{{ rule.destination.as_ref().unwrap_or(&"ANY".to_string()) }}</td>
                    <td>{{ rule.protocol.as_ref().map(|p| p.to_string()).unwrap_or("ANY".to_string()) }}</td>
                    <td>{{ rule.dport.as_ref().map(|p| p.to_string()).unwrap_or("-".to_string()) }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm" onclick="editRule({{ rule.id.unwrap_or(0) }})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteRule({{ rule.id.unwrap_or(0) }})">Delete</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- NAT Rules -->
    <div id="nat-rules" class="rule-table" style="display: none;">
        <table>
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Source</th>
                    <th>Destination</th>
                    <th>Interface</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for rule in nat_rules %}
                <tr class="rule-row">
                    <td>
                        {% if rule.enabled %}
                        <span class="badge success">Enabled</span>
                        {% else %}
                        <span class="badge danger">Disabled</span>
                        {% endif %}
                    </td>
                    <td><strong>{{ rule.name }}</strong></td>
                    <td><span class="badge info">{{ format!("{:?}", rule.nat_type) }}</span></td>
                    <td>{{ rule.source.as_ref().unwrap_or(&"ANY".to_string()) }}</td>
                    <td>{{ rule.destination.as_ref().unwrap_or(&"ANY".to_string()) }}</td>
                    <td>{{ rule.interface_out.as_ref().unwrap_or(&"-".to_string()) }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm" onclick="editNatRule({{ rule.id.unwrap_or(0) }})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteNatRule({{ rule.id.unwrap_or(0) }})">Delete</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Rule Modal -->
<div id="addRuleModal" class="modal">
    <div class="modal-content">
        <h2>Add Firewall Rule</h2>
        <form id="addRuleForm">
            <div class="form-group">
                <label>Rule Name</label>
                <input type="text" name="name" required placeholder="e.g., Allow SSH">
            </div>

            <div class="form-group">
                <label>Chain</label>
                <select name="chain" required>
                    <option value="input">INPUT</option>
                    <option value="output">OUTPUT</option>
                    <option value="forward">FORWARD</option>
                </select>
            </div>

            <div class="form-group">
                <label>Action</label>
                <select name="action" required>
                    <option value="accept">ACCEPT</option>
                    <option value="drop">DROP</option>
                    <option value="reject">REJECT</option>
                </select>
            </div>

            <div class="form-group">
                <label>Protocol</label>
                <select name="protocol">
                    <option value="">ANY</option>
                    <option value="tcp">TCP</option>
                    <option value="udp">UDP</option>
                    <option value="icmp">ICMP</option>
                </select>
            </div>

            <div class="form-group">
                <label>Source IP (optional)</label>
                <input type="text" name="source" placeholder="e.g., 192.168.1.0/24">
            </div>

            <div class="form-group">
                <label>Destination IP (optional)</label>
                <input type="text" name="destination" placeholder="e.g., 10.0.0.0/8">
            </div>

            <div class="form-group">
                <label>Destination Port (optional)</label>
                <input type="text" name="dport" placeholder="e.g., 22 or 80-443">
            </div>

            <div class="form-group">
                <label>Interface In (optional)</label>
                <input type="text" name="interface_in" placeholder="e.g., eth0">
            </div>

            <div class="form-group">
                <label>Comment (optional)</label>
                <input type="text" name="comment" placeholder="Describe this rule">
            </div>

            <div class="form-actions">
                <button type="button" class="btn" onclick="hideAddRuleModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Rule</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    function switchTab(tab) {
        // Update tab styling
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');

        // Show/hide rule tables
        document.getElementById('filter-rules').style.display = tab === 'filter' ? 'block' : 'none';
        document.getElementById('nat-rules').style.display = tab === 'nat' ? 'block' : 'none';
    }

    function showAddRuleModal() {
        document.getElementById('addRuleModal').classList.add('active');
    }

    function hideAddRuleModal() {
        document.getElementById('addRuleModal').classList.remove('active');
    }

    function editRule(id) {
        alert('Edit rule ' + id + ' - Feature coming soon!');
    }

    function deleteRule(id) {
        if (confirm('Delete this rule?')) {
            fetch('/api/firewall/rules/' + id, { method: 'DELETE' })
                .then(() => location.reload())
                .catch(err => alert('Error: ' + err));
        }
    }

    function editNatRule(id) {
        alert('Edit NAT rule ' + id + ' - Feature coming soon!');
    }

    function deleteNatRule(id) {
        if (confirm('Delete this NAT rule?')) {
            fetch('/api/firewall/nat/' + id, { method: 'DELETE' })
                .then(() => location.reload())
                .catch(err => alert('Error: ' + err));
        }
    }

    // Handle form submission
    document.getElementById('addRuleForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const rule = {
            name: formData.get('name'),
            chain: formData.get('chain'),
            action: formData.get('action'),
            protocol: formData.get('protocol') || null,
            source: formData.get('source') || null,
            destination: formData.get('destination') || null,
            dport: formData.get('dport') || null,
            interface_in: formData.get('interface_in') || null,
            comment: formData.get('comment') || null,
        };

        fetch('/api/firewall/rules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(rule)
        })
        .then(() => {
            hideAddRuleModal();
            location.reload();
        })
        .catch(err => alert('Error: ' + err));
    });

    // Close modal on background click
    document.getElementById('addRuleModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideAddRuleModal();
        }
    });
</script>
{% endblock %}
