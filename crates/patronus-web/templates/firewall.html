{% extends "base.html" %}

{% block title %}Firewall Rules - Patronus{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Firewall Rules</h1>
    <p class="page-subtitle">Manage firewall rules, NAT, and port forwarding</p>
    <div class="page-actions">
        <button class="btn btn-secondary btn-sm" onclick="exportRules()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Export
        </button>
        <button class="btn btn-primary btn-sm" onclick="showAddRuleModal()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Rule
        </button>
    </div>
</div>

<!-- Quick Stats -->
<div class="stat-grid">
    <div class="stat-card success">
        <h3>Filter Rules</h3>
        <div class="value">{{ filter_rules.len() }}</div>
        <div class="label">{{ filter_rules.iter().filter(|r| r.enabled).count() }} enabled</div>
    </div>

    <div class="stat-card info">
        <h3>NAT Rules</h3>
        <div class="value">{{ nat_rules.len() }}</div>
        <div class="label">{{ nat_rules.iter().filter(|r| r.enabled).count() }} enabled</div>
    </div>

    <div class="stat-card warning">
        <h3>Allow Rules</h3>
        <div class="value">{{ filter_rules.iter().filter(|r| r.action == "Accept").count() }}</div>
        <div class="label">Permissive rules</div>
    </div>

    <div class="stat-card danger">
        <h3>Drop Rules</h3>
        <div class="value">{{ filter_rules.iter().filter(|r| r.action == "Drop").count() }}</div>
        <div class="label">Blocking rules</div>
    </div>
</div>

<!-- Tabs -->
<div class="card">
    <div class="flex items-center justify-between mb-4">
        <div class="flex gap-4">
            <button class="btn btn-secondary" id="filterTab" onclick="switchTab('filter')" style="background: var(--primary); color: white;">
                Filter Rules
            </button>
            <button class="btn btn-secondary" id="natTab" onclick="switchTab('nat')">
                NAT Rules
            </button>
            <button class="btn btn-secondary" id="portforwardTab" onclick="switchTab('portforward')">
                Port Forwarding
            </button>
        </div>
        <input type="text" class="search-input" placeholder="Search rules..." style="width: 250px;" oninput="filterRules(this.value)">
    </div>

    <!-- Filter Rules -->
    <div id="filter-rules">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>Name</th>
                        <th>Chain</th>
                        <th>Action</th>
                        <th>Protocol</th>
                        <th>Source</th>
                        <th>Destination</th>
                        <th>Port</th>
                        <th>Status</th>
                        <th style="width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rule in filter_rules %}
                    <tr class="rule-row" data-rule-id="{{ rule.id.unwrap_or(0) }}">
                        <td>
                            <button class="btn-icon" onclick="toggleRuleDetails(this)">▶</button>
                        </td>
                        <td><strong>{{ rule.name }}</strong></td>
                        <td class="text-sm">{{ rule.chain }}</td>
                        <td>
                            {% if rule.action == "Accept" %}
                            <span class="badge success">{{ rule.action }}</span>
                            {% elsif rule.action == "Drop" %}
                            <span class="badge danger">{{ rule.action }}</span>
                            {% else %}
                            <span class="badge warning">{{ rule.action }}</span>
                            {% endif %}
                        </td>
                        <td class="text-sm">{{ rule.protocol.as_ref().map(|p| p.to_string()).unwrap_or("ANY".to_string()) }}</td>
                        <td class="text-sm">{{ rule.source.as_ref().unwrap_or(&"ANY".to_string()) }}</td>
                        <td class="text-sm">{{ rule.destination.as_ref().unwrap_or(&"ANY".to_string()) }}</td>
                        <td class="text-sm">{{ rule.dport.as_ref().map(|p| p.to_string()).unwrap_or("-".to_string()) }}</td>
                        <td>
                            {% if rule.enabled %}
                            <span class="badge success">On</span>
                            {% else %}
                            <span class="badge danger">Off</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn-icon" onclick="showRuleMenu(event, {{ rule.id.unwrap_or(0) }})">•••</button>
                        </td>
                    </tr>
                    <tr class="rule-details hidden" id="details-{{ rule.id.unwrap_or(0) }}">
                        <td colspan="10" style="background: var(--bg); padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <div class="text-sm text-muted">Interface In</div>
                                    <div class="font-bold">{{ rule.interface_in.as_ref().unwrap_or(&"ANY".to_string()) }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Interface Out</div>
                                    <div class="font-bold">{{ rule.interface_out.as_ref().unwrap_or(&"ANY".to_string()) }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Source Port</div>
                                    <div class="font-bold">{{ rule.sport.as_ref().map(|p| p.to_string()).unwrap_or("-".to_string()) }}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted">Comment</div>
                                    <div class="font-bold">{{ rule.comment.as_ref().unwrap_or(&"-".to_string()) }}</div>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-4">
                                <button class="btn btn-primary btn-sm" onclick="editRule({{ rule.id.unwrap_or(0) }})">Edit Rule</button>
                                <button class="btn btn-secondary btn-sm" onclick="duplicateRule({{ rule.id.unwrap_or(0) }})">Duplicate</button>
                                <button class="btn btn-secondary btn-sm" onclick="toggleRule({{ rule.id.unwrap_or(0) }})">{{ rule.enabled|then:"Disable"|else:"Enable" }}</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteRule({{ rule.id.unwrap_or(0) }})">Delete</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card-advanced hidden">
            <h3 class="mb-2 font-bold">Bulk Actions</h3>
            <div class="flex gap-2">
                <button class="btn btn-secondary btn-sm">Enable All</button>
                <button class="btn btn-secondary btn-sm">Disable All</button>
                <button class="btn btn-secondary btn-sm">Reorder Rules</button>
                <button class="btn btn-danger btn-sm">Delete All Disabled</button>
            </div>
            <h3 class="mb-2 font-bold mt-4">Import/Export</h3>
            <div class="flex gap-2">
                <button class="btn btn-secondary btn-sm" onclick="importRules()">Import from File</button>
                <button class="btn btn-secondary btn-sm" onclick="exportRules()">Export to YAML</button>
                <button class="btn btn-secondary btn-sm">Export to JSON</button>
            </div>
        </div>
        <button class="btn btn-link mt-4" onclick="toggleAdvanced(this)">Advanced Actions ▼</button>
    </div>

    <!-- NAT Rules -->
    <div id="nat-rules" class="hidden">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Source</th>
                        <th>Destination</th>
                        <th>Interface</th>
                        <th>Status</th>
                        <th style="width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rule in nat_rules %}
                    <tr class="rule-row">
                        <td>
                            <button class="btn-icon" onclick="toggleRuleDetails(this)">▶</button>
                        </td>
                        <td><strong>{{ rule.name }}</strong></td>
                        <td><span class="badge info">{{ format!("{:?}", rule.nat_type) }}</span></td>
                        <td class="text-sm">{{ rule.source.as_ref().unwrap_or(&"ANY".to_string()) }}</td>
                        <td class="text-sm">{{ rule.destination.as_ref().unwrap_or(&"ANY".to_string()) }}</td>
                        <td class="text-sm">{{ rule.interface_out.as_ref().unwrap_or(&"-".to_string()) }}</td>
                        <td>
                            {% if rule.enabled %}
                            <span class="badge success">On</span>
                            {% else %}
                            <span class="badge danger">Off</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn-icon" onclick="showRuleMenu(event, {{ rule.id.unwrap_or(0) }})">•••</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Port Forwarding (Simplified NAT DNAT) -->
    <div id="portforward-rules" class="hidden">
        <div class="card" style="margin-bottom: 1rem; background: var(--bg);">
            <p class="text-muted text-sm">Port forwarding allows external traffic to reach internal services. Configure which external ports should be forwarded to internal IP addresses.</p>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>External Port</th>
                        <th>→</th>
                        <th>Internal IP</th>
                        <th>Internal Port</th>
                        <th>Protocol</th>
                        <th>Status</th>
                        <th style="width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Web Server</strong></td>
                        <td class="text-sm">8080</td>
                        <td>→</td>
                        <td class="text-sm">192.168.1.10</td>
                        <td class="text-sm">80</td>
                        <td><span class="badge info">TCP</span></td>
                        <td><span class="badge success">On</span></td>
                        <td><button class="btn-icon">•••</button></td>
                    </tr>
                    <tr>
                        <td><strong>Game Server</strong></td>
                        <td class="text-sm">25565</td>
                        <td>→</td>
                        <td class="text-sm">192.168.1.20</td>
                        <td class="text-sm">25565</td>
                        <td><span class="badge info">TCP</span></td>
                        <td><span class="badge success">On</span></td>
                        <td><button class="btn-icon">•••</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Rule Modal -->
<div id="addRuleModal" class="modal">
    <div class="modal-content">
        <div class="flex items-center justify-between mb-4">
            <h2>Add Firewall Rule</h2>
            <button class="btn-icon" onclick="hideAddRuleModal()" style="font-size: 1.5rem;">×</button>
        </div>

        <form id="addRuleForm">
            <div class="form-group">
                <label>Rule Name *</label>
                <input type="text" name="name" required placeholder="e.g., Allow SSH from LAN">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Chain *</label>
                    <select name="chain" required>
                        <option value="input">INPUT</option>
                        <option value="output">OUTPUT</option>
                        <option value="forward">FORWARD</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Action *</label>
                    <select name="action" required>
                        <option value="accept">ACCEPT</option>
                        <option value="drop">DROP</option>
                        <option value="reject">REJECT</option>
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Protocol</label>
                    <select name="protocol">
                        <option value="">ANY</option>
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                        <option value="icmp">ICMP</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Destination Port</label>
                    <input type="text" name="dport" placeholder="e.g., 22 or 80-443">
                </div>
            </div>

            <div class="form-group">
                <label>Source IP/Network</label>
                <input type="text" name="source" placeholder="e.g., 192.168.1.0/24 or ANY">
            </div>

            <div class="form-group">
                <label>Destination IP/Network</label>
                <input type="text" name="destination" placeholder="e.g., 10.0.0.0/8 or ANY">
            </div>

            <div class="card-advanced hidden">
                <h3 class="mb-2 font-bold">Advanced Options</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Interface In</label>
                        <input type="text" name="interface_in" placeholder="e.g., eth0">
                    </div>

                    <div class="form-group">
                        <label>Interface Out</label>
                        <input type="text" name="interface_out" placeholder="e.g., eth1">
                    </div>
                </div>

                <div class="form-group">
                    <label>Source Port</label>
                    <input type="text" name="sport" placeholder="e.g., 1024-65535">
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="log"> Enable logging for this rule
                    </label>
                </div>
            </div>
            <button type="button" class="btn btn-link mb-4" onclick="toggleAdvanced(this)">Advanced Options ▼</button>

            <div class="form-group">
                <label>Comment</label>
                <input type="text" name="comment" placeholder="Describe this rule">
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="hideAddRuleModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Rule</button>
            </div>
        </form>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 8px;
    max-width: 700px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text);
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg);
    color: var(--text);
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
}

.rule-row {
    cursor: pointer;
}

.rule-row:hover {
    background: var(--bg);
}

.rule-details {
    display: none;
}

.rule-details.show {
    display: table-row;
}
</style>

{% endblock %}

{% block extra_scripts %}
<script>
    function switchTab(tab) {
        // Update button styling
        ['filterTab', 'natTab', 'portforwardTab'].forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.style.background = 'var(--bg)';
                btn.style.color = 'var(--text)';
            }
        });

        const activeBtn = document.getElementById(tab + 'Tab');
        if (activeBtn) {
            activeBtn.style.background = 'var(--primary)';
            activeBtn.style.color = 'white';
        }

        // Show/hide content
        document.getElementById('filter-rules').classList.toggle('hidden', tab !== 'filter');
        document.getElementById('nat-rules').classList.toggle('hidden', tab !== 'nat');
        document.getElementById('portforward-rules').classList.toggle('hidden', tab !== 'portforward');
    }

    function toggleRuleDetails(btn) {
        const row = btn.closest('tr');
        const detailsRow = row.nextElementSibling;
        if (detailsRow && detailsRow.classList.contains('rule-details')) {
            detailsRow.classList.toggle('show');
            btn.textContent = detailsRow.classList.contains('show') ? '▼' : '▶';
        }
    }

    function showAddRuleModal() {
        document.getElementById('addRuleModal').classList.add('active');
    }

    function hideAddRuleModal() {
        document.getElementById('addRuleModal').classList.remove('active');
    }

    function editRule(id) {
        alert('Edit rule ' + id + ' - Feature will open edit modal');
    }

    function duplicateRule(id) {
        if (confirm('Duplicate this rule?')) {
            alert('Duplicating rule ' + id);
        }
    }

    function toggleRule(id) {
        fetch('/api/firewall/rules/' + id + '/toggle', { method: 'POST' })
            .then(() => location.reload())
            .catch(err => alert('Error: ' + err));
    }

    function deleteRule(id) {
        if (confirm('Delete this rule? This action cannot be undone.')) {
            fetch('/api/firewall/rules/' + id, { method: 'DELETE' })
                .then(() => location.reload())
                .catch(err => alert('Error: ' + err));
        }
    }

    function filterRules(query) {
        const rows = document.querySelectorAll('.rule-row');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
        });
    }

    function exportRules() {
        window.location.href = '/api/firewall/export?format=yaml';
    }

    function importRules() {
        alert('Import functionality coming soon');
    }

    // Handle form submission
    document.getElementById('addRuleForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const rule = {
            name: formData.get('name'),
            chain: formData.get('chain'),
            action: formData.get('action'),
            protocol: formData.get('protocol') || null,
            source: formData.get('source') || null,
            destination: formData.get('destination') || null,
            dport: formData.get('dport') || null,
            sport: formData.get('sport') || null,
            interface_in: formData.get('interface_in') || null,
            interface_out: formData.get('interface_out') || null,
            comment: formData.get('comment') || null,
            log: formData.get('log') === 'on',
        };

        fetch('/api/firewall/rules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(rule)
        })
        .then(() => {
            hideAddRuleModal();
            location.reload();
        })
        .catch(err => alert('Error: ' + err));
    });

    // Close modal on background click
    document.getElementById('addRuleModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideAddRuleModal();
        }
    });
</script>
{% endblock %}
