<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI & Monitoring - Patronus</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .stat-card { border: 1px solid #ddd; padding: 15px; margin: 10px; border-radius: 5px; }
        .badge { padding: 3px 8px; border-radius: 3px; font-size: 0.8em; }
        .badge.success { background: #28a745; color: white; }
        .badge.info { background: #17a2b8; color: white; }
        .badge.warning { background: #ffc107; color: black; }
        .badge.danger { background: #dc3545; color: white; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .btn { padding: 6px 12px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; }
        .btn.btn-primary { background: #007bff; color: white; }
        .btn.btn-secondary { background: #6c757d; color: white; }
        .btn.btn-success { background: #28a745; color: white; }
        .btn.btn-warning { background: #ffc107; color: black; }
        .btn.btn-danger { background: #dc3545; color: white; }
        .btn-sm { padding: 4px 8px; font-size: 0.875em; }
        .btn-icon { background: none; border: none; cursor: pointer; padding: 4px; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; }
        .tab-btn.active { background: #f8f9fa; border-bottom: 2px solid #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { border: 1px solid #ddd; border-radius: 5px; padding: 20px; margin: 20px 0; }
        .card-header { margin-bottom: 15px; }
        .card-title { margin: 0; }
        .flex { display: flex; }
        .gap-2 { gap: 8px; }
        .text-sm { font-size: 0.875em; }
        .text-muted { color: #6c757d; }
        .monospace { font-family: monospace; }
        .font-bold { font-weight: bold; }
        .search-input { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; }
        .w-full { width: 100%; }
        .hidden { display: none; }
        .mt-4 { margin-top: 16px; }
        .mt-2 { margin-top: 8px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .value { font-size: 2em; font-weight: bold; color: #007bff; }
        .label { color: #6c757d; margin-top: 5px; }
        .page-header { margin-bottom: 30px; }
        .page-title { margin: 0; color: #333; }
        .page-subtitle { margin: 5px 0 0 0; color: #6c757d; }
        .page-actions { margin-top: 15px; }
        .table-container { overflow-x: auto; }
        .card-advanced { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 5px; }
        .btn-link { background: none; border: none; color: #007bff; cursor: pointer; text-decoration: underline; }
        .row-details { background: #f8f9fa; }
        .row-details.hidden { display: none; }
        .data-row { }
        .show { display: table-row !important; }
    </style>
</head>
<body>
    <div class="page-header">
        <h1 class="page-title">AI Threat Detection & Monitoring</h1>
        <p class="page-subtitle">Machine learning-powered security and real-time system monitoring</p>
        <div class="page-actions">
            <button class="btn btn-secondary btn-sm" onclick="exportMetrics()">
                Export Metrics
            </button>
            <button class="btn btn-primary btn-sm" onclick="trainAIModel()">
                Retrain AI Model
            </button>
        </div>
    </div>

    <!-- AI & Monitoring Stats -->
    <div class="stat-grid">
        <div class="stat-card success">
            <h3>Threat Detection</h3>
            <div class="value">{{ threats_detected_today }}</div>
            <div class="label">{{ threats_blocked_today }} blocked today</div>
        </div>

        <div class="stat-card info">
            <h3>AI Model Accuracy</h3>
            <div class="value">{{ ai_model_accuracy }}%</div>
            <div class="label">{{ ai_model_confidence }}% confidence</div>
        </div>

        <div class="stat-card warning">
            <h3>System Health</h3>
            <div class="value">{{ system_health_score }}/100</div>
            <div class="label">{{ active_alerts }} active alerts</div>
        </div>

        <div class="stat-card danger">
            <h3>Packet Analysis</h3>
            <div class="value">{{ packets_analyzed_rate }}/s</div>
            <div class="label">{{ packets_total }} total</div>
        </div>
    </div>

    <!-- AI & Monitoring Tabs -->
    <div class="card">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(event, 'threats-tab')">
                AI Threat Detection
            </button>
            <button class="tab-btn" onclick="switchTab(event, 'alerts-tab')">
                Alerts & Events
            </button>
            <button class="tab-btn" onclick="switchTab(event, 'metrics-tab')">
                System Metrics
            </button>
            <button class="tab-btn" onclick="switchTab(event, 'logs-tab')">
                Live Logs
            </button>
        </div>

        <!-- AI Threat Detection Tab -->
        <div id="threats-tab" class="tab-content active">
            <div class="card-header">
                <h2 class="card-title">AI-Detected Threats</h2>
                <div class="flex gap-2">
                    <input type="search" placeholder="Search threats..." class="search-input"
                           oninput="filterTable(this.value, 'threats-table')">
                    <select class="search-input" style="width: auto;" onchange="filterBySeverity(this.value)">
                        <option value="">All Severities</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <table id="threats-table">
                    <thead>
                        <tr>
                            <th width="30"></th>
                            <th>Timestamp</th>
                            <th>Threat Type</th>
                            <th>Source IP</th>
                            <th>Destination</th>
                            <th>Severity</th>
                            <th>Confidence</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for threat in ai_threats %}
                        <tr class="data-row" data-severity="{{ threat.severity }}">
                            <td>
                                <button class="btn-icon" onclick="toggleRowDetails(this)">‚ñ∂</button>
                            </td>
                            <td class="text-sm">{{ threat.timestamp }}</td>
                            <td><strong>{{ threat.threat_type }}</strong></td>
                            <td class="text-sm monospace">{{ threat.source_ip }}</td>
                            <td class="text-sm">{{ threat.destination }}</td>
                            <td>
                                {% if threat.severity == "critical" %}
                                <span class="badge danger">Critical</span>
                                {% else if threat.severity == "high" %}
                                <span class="badge warning">High</span>
                                {% else if threat.severity == "medium" %}
                                <span class="badge info">Medium</span>
                                {% else %}
                                <span class="badge">Low</span>
                                {% endif %}
                            </td>
                            <td class="text-sm">{{ threat.confidence }}%</td>
                            <td>
                                {% if threat.blocked %}
                                <span class="badge success">Blocked</span>
                                {% else %}
                                <span class="badge warning">Detected</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn-icon" onclick="threatActions('{{ threat.id }}')">‚Ä¢‚Ä¢‚Ä¢</button>
                            </td>
                        </tr>
                        <tr class="row-details hidden">
                            <td colspan="9" style="background: #f8f9fa; padding: 1.5rem;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                    <div>
                                        <div class="text-sm text-muted">Detection Method</div>
                                        <div class="font-bold">{{ threat.detection_method }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted">ML Model</div>
                                        <div class="font-bold">{{ threat.ml_model }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted">Anomaly Score</div>
                                        <div class="font-bold">{{ threat.anomaly_score }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted">Port</div>
                                        <div class="font-bold">{{ threat.port }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted">Protocol</div>
                                        <div class="font-bold">{{ threat.protocol }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted">Packet Count</div>
                                        <div class="font-bold">{{ threat.packet_count }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted">Bytes Transferred</div>
                                        <div class="font-bold">{{ threat.bytes }}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted">GeoIP</div>
                                        <div class="font-bold">{{ threat.geoip_display }}</div>
                                    </div>
                                </div>

                                <div style="margin-top: 1rem;">
                                    <div class="text-sm text-muted">Threat Intelligence</div>
                                    <div class="font-bold mt-2">{{ threat.threat_intel_display }}</div>
                                </div>

                                <div style="margin-top: 1rem;">
                                    <div class="text-sm text-muted">Recommended Action</div>
                                    <div class="font-bold mt-2">{{ threat.recommended_action }}</div>
                                </div>

                                <div class="flex gap-2 mt-4">
                                    {% if !threat.blocked %}
                                    <button class="btn btn-danger btn-sm" onclick="blockThreat('{{ threat.id }}')">
                                        Block Now
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-primary btn-sm" onclick="createRuleFromThreat('{{ threat.id }}')">
                                        Create Firewall Rule
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="whitelistThreat('{{ threat.id }}')">
                                        Whitelist (False Positive)
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Alerts & Events Tab -->
        <div id="alerts-tab" class="tab-content">
            <div class="card-header">
                <h2 class="card-title">System Alerts & Events</h2>
                <div class="flex gap-2">
                    <input type="search" placeholder="Search alerts..." class="search-input"
                           oninput="filterTable(this.value, 'alerts-table')">
                    <button class="btn btn-sm btn-secondary" onclick="acknowledgeAllAlerts()">
                        Mark All Read
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table id="alerts-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Alert Type</th>
                            <th>Severity</th>
                            <th>Component</th>
                            <th>Message</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for alert in alerts %}
                        <tr class="data-row">
                            <td class="text-sm">{{ alert.timestamp }}</td>
                            <td><strong>{{ alert.alert_type }}</strong></td>
                            <td>
                                {% if alert.severity == "critical" %}
                                <span class="badge danger">Critical</span>
                                {% else if alert.severity == "warning" %}
                                <span class="badge warning">Warning</span>
                                {% else %}
                                <span class="badge info">Info</span>
                                {% endif %}
                            </td>
                            <td class="text-sm">{{ alert.component }}</td>
                            <td class="text-sm">{{ alert.message }}</td>
                            <td>
                                {% if alert.acknowledged %}
                                <span class="badge">Read</span>
                                {% else %}
                                <span class="badge warning">Unread</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if !alert.acknowledged %}
                                <button class="btn btn-sm btn-secondary" onclick="acknowledgeAlert('{{ alert.id }}')">
                                    Acknowledge
                                </button>
                                {% endif %}
                                <button class="btn-icon" onclick="deleteAlert('{{ alert.id }}')">üóë</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- System Metrics Tab -->
        <div id="metrics-tab" class="tab-content">
            <div class="card-header">
                <h2 class="card-title">Real-Time System Metrics</h2>
                <div class="flex gap-2">
                    <select class="search-input" style="width: auto;" onchange="changeMetricTimerange(this.value)">
                        <option value="1h">Last Hour</option>
                        <option value="24h" selected>Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                    </select>
                </div>
            </div>

            <!-- Metrics Grid -->
            <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem;">
                <!-- System Metrics Chart (CPU, Memory, Disk) -->
                <div class="card">
                    <h3 class="font-bold mb-2">System Resources</h3>
                    <div style="height: 300px;">
                        <canvas id="system-metrics-chart"></canvas>
                    </div>
                </div>

                <!-- Network Throughput Chart -->
                <div class="card">
                    <h3 class="font-bold mb-2">Network Throughput</h3>
                    <div style="height: 300px;">
                        <canvas id="network-throughput-chart"></canvas>
                    </div>
                </div>

                <!-- Interface Stats -->
                <div class="card">
                    <h3 class="font-bold mb-2">Interface Statistics</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Interface</th>
                                    <th>RX Rate</th>
                                    <th>TX Rate</th>
                                    <th>RX Packets</th>
                                    <th>TX Packets</th>
                                    <th>Errors</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in interface_stats %}
                                <tr>
                                    <td><strong>{{ stat.name }}</strong></td>
                                    <td class="text-sm">{{ stat.rx_rate }}</td>
                                    <td class="text-sm">{{ stat.tx_rate }}</td>
                                    <td class="text-sm">{{ stat.rx_packets }}</td>
                                    <td class="text-sm">{{ stat.tx_packets }}</td>
                                    <td class="text-sm">{{ stat.errors }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Connections -->
                <div class="card">
                    <h3 class="font-bold mb-2">Top Connections</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Destination</th>
                                    <th>Protocol</th>
                                    <th>Bytes</th>
                                    <th>Packets</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for conn in top_connections %}
                                <tr>
                                    <td class="text-sm monospace">{{ conn.source }}</td>
                                    <td class="text-sm monospace">{{ conn.destination }}</td>
                                    <td class="text-sm">{{ conn.protocol }}</td>
                                    <td class="text-sm">{{ conn.bytes }}</td>
                                    <td class="text-sm">{{ conn.packets }}</td>
                                    <td class="text-sm">{{ conn.duration }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Logs Tab -->
        <div id="logs-tab" class="tab-content">
            <div class="card-header">
                <h2 class="card-title">Live System Logs</h2>
                <div class="flex gap-2">
                    <select class="search-input" style="width: auto;" onchange="changeLogSource(this.value)">
                        <option value="all">All Logs</option>
                        <option value="firewall">Firewall</option>
                        <option value="vpn">VPN</option>
                        <option value="dns">DNS</option>
                        <option value="dhcp">DHCP</option>
                        <option value="system">System</option>
                    </select>
                    <button class="btn btn-sm btn-secondary" onclick="pauseLiveLogs()">
                        ‚è∏ Pause
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="clearLogs()">
                        Clear Display
                    </button>
                </div>
            </div>

            <div style="background: #1a1a1a; color: #00ff00; font-family: monospace; font-size: 0.875rem; padding: 1rem; border-radius: 0.5rem; height: 500px; overflow-y: auto;" id="live-logs">
                {% for log in live_logs %}
                <div style="margin-bottom: 0.25rem;">
                    <span style="color: #888;">[{{ log.timestamp }}]</span>
                    <span style="color: {{ log.level_color }};">[{{ log.level }}]</span>
                    <span style="color: #00aaff;">[{{ log.component }}]</span>
                    {{ log.message }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // Tab switching
        function switchTab(event, tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Toggle row details
        function toggleRowDetails(btn) {
            const row = btn.closest('tr');
            const detailsRow = row.nextElementSibling;
            if (detailsRow && detailsRow.classList.contains('row-details')) {
                detailsRow.classList.toggle('show');
                btn.textContent = detailsRow.classList.contains('show') ? '‚ñº' : '‚ñ∂';
            }
        }

        // Filter table
        function filterTable(query, tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const rows = table.querySelectorAll('tbody tr.data-row');
            query = query.toLowerCase();

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const detailsRow = row.nextElementSibling;

                if (text.includes(query)) {
                    row.style.display = '';
                    if (detailsRow && detailsRow.classList.contains('row-details')) {
                        detailsRow.style.display = '';
                    }
                } else {
                    row.style.display = 'none';
                    if (detailsRow && detailsRow.classList.contains('row-details')) {
                        detailsRow.style.display = 'none';
                    }
                }
            });
        }

        // Filter by severity
        function filterBySeverity(severity) {
            const table = document.getElementById('threats-table');
            const rows = table.querySelectorAll('tbody tr.data-row');

            rows.forEach(row => {
                const rowSeverity = row.getAttribute('data-severity');
                const detailsRow = row.nextElementSibling;

                if (severity === '' || rowSeverity === severity) {
                    row.style.display = '';
                    if (detailsRow && detailsRow.classList.contains('row-details')) {
                        detailsRow.style.display = '';
                    }
                } else {
                    row.style.display = 'none';
                    if (detailsRow && detailsRow.classList.contains('row-details')) {
                        detailsRow.style.display = 'none';
                    }
                }
            });
        }

        // Threat actions
        function threatActions(id) {
            alert(`Threat actions for ${id}`);
        }

        function blockThreat(id) {
            if (confirm('Block this threat source immediately?')) {
                alert(`Blocking threat ${id}...`);
            }
        }

        function createRuleFromThreat(id) {
            alert(`Creating firewall rule from threat ${id}...`);
        }

        function whitelistThreat(id) {
            if (confirm('Mark this as a false positive? The AI model will be retrained.')) {
                alert(`Whitelisting threat ${id}...`);
            }
        }

        // AI model actions
        function trainAIModel() {
            if (confirm('Retrain AI model? This may take several minutes.')) {
                alert('Training AI model with latest data...');
            }
        }

        // Alert actions
        function acknowledgeAlert(id) {
            alert(`Acknowledging alert ${id}...`);
        }

        function acknowledgeAllAlerts() {
            if (confirm('Mark all alerts as read?')) {
                alert('Acknowledging all alerts...');
            }
        }

        function deleteAlert(id) {
            if (confirm('Delete this alert?')) {
                alert(`Deleting alert ${id}...`);
            }
        }

        // Metrics actions
        function changeMetricTimerange(range) {
            alert(`Changing timerange to: ${range}`);
        }

        function exportMetrics() {
            alert('Exporting metrics...');
        }

        // Log actions
        let logsPaused = false;
        function pauseLiveLogs() {
            logsPaused = !logsPaused;
            event.target.textContent = logsPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
        }

        function clearLogs() {
            document.getElementById('live-logs').innerHTML = '';
        }

        function changeLogSource(source) {
            alert(`Filtering logs by: ${source}`);
        }

        // Initialize charts when the metrics tab is visible
        let chartsInitialized = false;
        function initializeCharts() {
            if (chartsInitialized) return;

            // System Metrics Chart
            const sysCtx = document.getElementById('system-metrics-chart');
            if (sysCtx) {
                new Chart(sysCtx, {
                    type: 'line',
                    data: {
                        labels: ['1h ago', '45m ago', '30m ago', '15m ago', 'Now'],
                        datasets: [{
                            label: 'CPU %',
                            data: [65, 59, 80, 81, 56],
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1
                        }, {
                            label: 'Memory %',
                            data: [28, 48, 40, 19, 86],
                            borderColor: 'rgb(54, 162, 235)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            // Network Throughput Chart
            const netCtx = document.getElementById('network-throughput-chart');
            if (netCtx) {
                new Chart(netCtx, {
                    type: 'line',
                    data: {
                        labels: ['1h ago', '45m ago', '30m ago', '15m ago', 'Now'],
                        datasets: [{
                            label: 'RX Mbps',
                            data: [12, 19, 3, 5, 2],
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }, {
                            label: 'TX Mbps',
                            data: [7, 11, 5, 8, 3],
                            borderColor: 'rgb(255, 159, 64)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            chartsInitialized = true;
        }

        // Initialize charts when metrics tab is clicked
        document.addEventListener('click', function(e) {
            if (e.target.textContent === 'System Metrics') {
                setTimeout(initializeCharts, 100);
            }
        });

        // Simulate live logs (in production, use WebSocket)
        setInterval(() => {
            if (!logsPaused && document.getElementById('logs-tab').classList.contains('active')) {
                const logsDiv = document.getElementById('live-logs');
                const now = new Date().toISOString();
                const levels = ['INFO', 'WARN', 'ERROR'];
                const components = ['FIREWALL', 'VPN', 'DNS', 'DHCP', 'SYSTEM'];
                const messages = [
                    'Connection established from 192.168.1.100',
                    'DNS query for example.com resolved',
                    'DHCP lease assigned to 00:11:22:33:44:55',
                    'Firewall rule applied: ACCEPT',
                    'VPN peer handshake successful'
                ];

                const level = levels[Math.floor(Math.random() * levels.length)];
                const component = components[Math.floor(Math.random() * components.length)];
                const message = messages[Math.floor(Math.random() * messages.length)];

                const color = level === 'ERROR' ? '#ff0000' : level === 'WARN' ? '#ffaa00' : '#00ff00';

                const logEntry = `
                    <div style="margin-bottom: 0.25rem;">
                        <span style="color: #888;">[${now}]</span>
                        <span style="color: ${color};">[${level}]</span>
                        <span style="color: #00aaff;">[${component}]</span>
                        ${message}
                    </div>
                `;

                logsDiv.innerHTML += logEntry;
                logsDiv.scrollTop = logsDiv.scrollHeight;

                // Keep only last 100 entries
                const entries = logsDiv.querySelectorAll('div');
                if (entries.length > 100) {
                    entries[0].remove();
                }
            }
        }, 2000);
    </script>
</body>
</html>